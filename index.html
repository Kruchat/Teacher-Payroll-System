<!DOCTYPE html>
<html lang="th" x-data="appState()" x-init="init()" :class="{'dark': darkMode}">
<head>
  <meta charset="UTF-8" />
  <title>{{APP_NAME}}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#38bdf8',
            warning: '#fbbf24',
            danger: '#f87171',
            success: '#34d399',
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(148, 163, 184, 0.5); border-radius: 9999px; }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="min-h-screen transition-colors" :class="darkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-100 text-slate-900'">
  <div class="absolute inset-0 -z-10 bg-gradient-to-br from-primary/5 via-slate-100 to-slate-200 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950"></div>
  <div class="max-w-7xl mx-auto px-4 py-10 space-y-8">
    <header class="rounded-3xl bg-white/80 dark:bg-slate-900/40 backdrop-blur border border-white/60 dark:border-slate-800/70 shadow-xl p-6 lg:p-8 space-y-6">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div class="space-y-5">
          <div class="inline-flex items-center gap-3 text-[0.65rem] font-semibold tracking-[0.4em] uppercase text-primary dark:text-primary/80">
            <span class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center shadow-inner">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 3h15a1.5 1.5 0 011.5 1.5v15a1.5 1.5 0 01-1.5 1.5h-15A1.5 1.5 0 013 19.5v-15A1.5 1.5 0 014.5 3zm3 4.5h9M7.5 12h9M7.5 15h5.25" />
              </svg>
            </span>
            <span>Document Intelligence Hub</span>
          </div>
          <div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white">{{APP_NAME}}</h1>
            <p class="mt-3 text-base md:text-lg text-slate-600 dark:text-slate-300 max-w-2xl">
              ระบบจัดเก็บเอกสารที่รวมศูนย์ไฟล์จาก Google Drive พร้อมเมตาดาต้าใน Google Sheets ครบทั้งอัปโหลด ค้นหา แจ้งเตือน และสำรองข้อมูลในที่เดียว
            </p>
          </div>
          <div class="flex flex-wrap gap-2">
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border text-xs font-semibold transition"
              :class="settings.isSheetReady ? 'border-success/40 bg-success/10 text-success' : 'border-warning/40 bg-warning/10 text-warning'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m3.75-5.25h-13.5c-.414 0-.75.336-.75.75v13.5c0 .414.336.75.75.75h13.5c.414 0 .75-.336.75-.75v-13.5c0-.414-.336-.75-.75-.75z" />
              </svg>
              <span>Sheet: <span x-text="settings.isSheetReady ? 'พร้อม' : 'รอตั้งค่า'"></span></span>
            </span>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border text-xs font-semibold transition"
              :class="settings.isFolderReady ? 'border-success/40 bg-success/10 text-success' : 'border-warning/40 bg-warning/10 text-warning'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5A1.5 1.5 0 014.5 6h5.379a1.5 1.5 0 011.06.44l1.122 1.12a1.5 1.5 0 001.06.44H19.5A1.5 1.5 0 0121 9v8.25a1.5 1.5 0 01-1.5 1.5h-15A1.5 1.5 0 013 17.25V7.5z" />
              </svg>
              <span>Drive: <span x-text="settings.isFolderReady ? 'พร้อม' : 'รอตั้งค่า'"></span></span>
            </span>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border text-xs font-semibold transition"
              :class="isLocked ? 'border-slate-400 bg-slate-100 text-slate-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300' : 'border-success/40 bg-success/10 text-success'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V9a4.5 4.5 0 00-9 0v1.5m-.75 0h10.5a.75.75 0 01.75.75v7.5a.75.75 0 01-.75.75h-10.5a.75.75 0 01-.75-.75v-7.5a.75.75 0 01.75-.75z" />
              </svg>
              <span x-text="isLocked ? 'โหมดผู้ดูแล: ล็อก' : 'โหมดผู้ดูแล: ปลดล็อก'"></span>
            </span>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <button @click="toggleDarkMode" class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/70 hover:-translate-y-0.5 hover:shadow-lg transition disabled:opacity-50">
            <span class="relative flex h-4 w-4 items-center justify-center" x-cloak>
              <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 15a5 5 0 100-10 5 5 0 000 10z" />
              </svg>
              <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M17.293 13.293a8 8 0 01-10.586-10.586 1 1 0 00-1.32-1.32A10 10 0 1018.613 14.613a1 1 0 00-1.32-1.32z" clip-rule="evenodd" />
              </svg>
            </span>
            <span x-text="darkMode ? 'เปิดโหมดสว่าง' : 'เปิดโหมดมืด'"></span>
          </button>
          <button @click="refresh" class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl border border-primary/30 bg-primary/10 text-primary hover:bg-primary/20 hover:-translate-y-0.5 hover:shadow-lg transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.477V4.87M21 12a9 9 0 11-3.86-7.385" />
            </svg>
            <span>รีเฟรชข้อมูล</span>
          </button>
          <button @click="openCreateForm" :disabled="isLocked" class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-gradient-to-r from-success to-emerald-400 text-white font-semibold shadow-lg shadow-emerald-500/30 hover:shadow-xl transition disabled:opacity-40 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            <span>เพิ่มเอกสาร</span>
          </button>
          <button @click="openSettings" class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/70 hover:-translate-y-0.5 hover:shadow-lg transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317a1.5 1.5 0 012.35 0l.715.894a1.5 1.5 0 001.463.51l1.137-.227a1.5 1.5 0 011.742 1.742l-.227 1.137a1.5 1.5 0 00.51 1.463l.894.715a1.5 1.5 0 010 2.35l-.894.715a1.5 1.5 0 00-.51 1.463l.227 1.137a1.5 1.5 0 01-1.742 1.742l-1.137-.227a1.5 1.5 0 00-1.463.51l-.715.894a1.5 1.5 0 01-2.35 0l-.715-.894a1.5 1.5 0 00-1.463-.51l-1.137.227a1.5 1.5 0 01-1.742-1.742l.227-1.137a1.5 1.5 0 00-.51-1.463l-.894-.715a1.5 1.5 0 010-2.35l.894-.715a1.5 1.5 0 00.51-1.463l-.227-1.137a1.5 1.5 0 011.742-1.742l1.137.227a1.5 1.5 0 001.463-.51l.715-.894z" />
            </svg>
            <span>ตั้งค่า</span>
          </button>
        </div>
      </div>
      <div class="rounded-2xl border border-dashed border-slate-300/70 dark:border-slate-700/70 bg-white/70 dark:bg-slate-900/40 p-4 sm:p-5 text-xs sm:text-sm text-slate-600 dark:text-slate-300 flex flex-wrap gap-3 items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-primary/10 text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 9.75l7.5 7.5 7.5-7.5" />
            </svg>
          </span>
          <div>
            <div class="font-semibold text-slate-900 dark:text-white">ฐานข้อมูลพร้อมใช้งานหรือไม่?</div>
            <p class="text-xs sm:text-sm" x-text="settings.readyForData ? 'เชื่อมต่อชีตเรียบร้อย สามารถเรียกดูข้อมูลได้ทันที' : 'โปรดสร้างหรือเชื่อมต่อชีต และโฟลเดอร์จากหน้า Settings ก่อนเริ่มใช้งาน'">
            </p>
          </div>
        </div>
        <button @click="openSettings" class="inline-flex items-center gap-2 rounded-full border border-primary/40 bg-primary/10 px-3 py-2 text-primary hover:bg-primary/20">
          <span>จัดการการตั้งค่า</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </header>

    <section class="grid gap-4 md:grid-cols-3" id="dashboard">
      <div class="relative overflow-hidden rounded-3xl border border-white/60 dark:border-slate-800/70 bg-white/80 dark:bg-slate-900/40 backdrop-blur p-6 shadow-lg">
        <div class="absolute inset-0 bg-gradient-to-br from-primary/10 via-primary/0 to-transparent dark:from-primary/20 opacity-70 pointer-events-none"></div>
        <div class="relative flex items-start justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-slate-500 dark:text-slate-400">เอกสารทั้งหมด</p>
            <p class="mt-2 text-4xl font-bold text-slate-900 dark:text-white" x-text="summary.total"></p>
            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">จำนวนรายการทั้งหมดในระบบ</p>
          </div>
          <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-primary/10 text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6.75h15m-15 4.5h15m-15 4.5H12" />
            </svg>
          </span>
        </div>
        <div class="relative mt-6 rounded-xl border border-dashed border-primary/30 bg-primary/5 px-4 py-3 text-xs text-primary">
          <div class="font-semibold">สถานะล่าสุด</div>
          <p>รีเฟรชข้อมูลล่าสุดด้วยปุ่มด้านบนเพื่อให้ตัวเลขอัปเดตตลอดเวลา</p>
        </div>
      </div>
      <div class="relative overflow-hidden rounded-3xl border border-white/60 dark:border-slate-800/70 bg-white/80 dark:bg-slate-900/40 backdrop-blur p-6 shadow-lg">
        <div class="absolute inset-0 bg-gradient-to-br from-warning/10 via-warning/0 to-transparent dark:from-warning/10 opacity-60 pointer-events-none"></div>
        <div class="relative flex items-start justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-warning/80">ใกล้หมดอายุ</p>
            <p class="mt-2 text-4xl font-bold text-warning" x-text="summary.aboutToExpire"></p>
            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">ควรติดตามเพื่อเตรียมต่ออายุหรือจัดการ</p>
          </div>
          <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-warning/10 text-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3h.008v.008H12V15z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3.75c-4.556 0-8.25 3.694-8.25 8.25s3.694 8.25 8.25 8.25 8.25-3.694 8.25-8.25S16.556 3.75 12 3.75z" />
            </svg>
          </span>
        </div>
        <div class="relative mt-6 flex items-center justify-between rounded-xl border border-warning/30 bg-warning/5 px-4 py-3 text-xs text-warning">
          <span>ตั้งค่าจำนวนวันแจ้งเตือนในแต่ละรายการเพื่อไม่ให้พลาด</span>
          <button @click="filters.status = 'active'; applyFilters()" class="rounded-full bg-warning/20 px-3 py-1 text-[11px] font-semibold hover:bg-warning/30">ดูรายการ</button>
        </div>
      </div>
      <div class="relative overflow-hidden rounded-3xl border border-white/60 dark:border-slate-800/70 bg-white/80 dark:bg-slate-900/40 backdrop-blur p-6 shadow-lg">
        <div class="absolute inset-0 bg-gradient-to-br from-danger/10 via-danger/0 to-transparent dark:from-danger/20 opacity-60 pointer-events-none"></div>
        <div class="relative flex items-start justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-danger/80">หมดอายุแล้ว</p>
            <p class="mt-2 text-4xl font-bold text-danger" x-text="summary.expired"></p>
            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">ตรวจสอบเอกสารที่ต้องจัดการหรือย้ายสถานะ</p>
          </div>
          <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-danger/10 text-danger">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 6.75l.66 9.24a2.25 2.25 0 002.244 2.01h7.692a2.25 2.25 0 002.244-2.01l.66-9.24a1.5 1.5 0 00-1.494-1.59H6.744a1.5 1.5 0 00-1.494 1.59z" />
            </svg>
          </span>
        </div>
        <div class="relative mt-6 flex items-center justify-between rounded-xl border border-danger/30 bg-danger/5 px-4 py-3 text-xs text-danger">
          <span>เปิดดูรายละเอียดและปรับสถานะ หรืออัปเดตไฟล์ล่าสุด</span>
          <button @click="filters.status = 'expired'; applyFilters()" class="rounded-full bg-danger/20 px-3 py-1 text-[11px] font-semibold hover:bg-danger/30">กรองทันที</button>
        </div>
      </div>
    </section>

    <section class="rounded-3xl border border-white/60 dark:border-slate-800/70 bg-white/80 dark:bg-slate-900/40 backdrop-blur shadow-xl">
      <div class="border-b border-slate-200/60 dark:border-slate-700/60 px-6 py-6 space-y-4">
        <div class="flex flex-col gap-3 xl:flex-row xl:items-center xl:justify-between">
          <div class="flex flex-wrap items-center gap-3">
            <div class="inline-flex rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/60 p-1">
              <button @click="viewMode = 'table'" class="px-4 py-2 text-xs font-semibold rounded-full transition"
                :class="viewMode === 'table' ? 'bg-primary text-white shadow' : 'text-slate-500 dark:text-slate-400'">มุมมองตาราง</button>
              <button @click="viewMode = 'card'" class="px-4 py-2 text-xs font-semibold rounded-full transition"
                :class="viewMode === 'card' ? 'bg-primary text-white shadow' : 'text-slate-500 dark:text-slate-400'">มุมมองการ์ด</button>
            </div>
            <div class="text-xs uppercase tracking-widest text-slate-500 dark:text-slate-400">
              ผลลัพธ์ <span class="font-semibold text-primary" x-text="total"></span> รายการ
            </div>
          </div>
          <div class="flex flex-wrap gap-2 text-xs font-semibold">
            <button @click="filters.status = ''; applyFilters()" class="rounded-full border px-3 py-1 transition"
              :class="filters.status === '' ? 'border-primary/40 bg-primary/15 text-primary' : 'border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'">ทั้งหมด</button>
            <button @click="filters.status = 'active'; applyFilters()" class="rounded-full border px-3 py-1 transition"
              :class="filters.status === 'active' ? 'border-success/40 bg-success/15 text-success' : 'border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'">Active</button>
            <button @click="filters.status = 'archived'; applyFilters()" class="rounded-full border px-3 py-1 transition"
              :class="filters.status === 'archived' ? 'border-slate-400 bg-slate-200/70 text-slate-600 dark:bg-slate-800/60 dark:text-slate-300' : 'border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'">Archived</button>
            <button @click="filters.status = 'expired'; applyFilters()" class="rounded-full border px-3 py-1 transition"
              :class="filters.status === 'expired' ? 'border-danger/40 bg-danger/15 text-danger' : 'border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400'">Expired</button>
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4 items-end">
          <label class="relative flex flex-col gap-2 xl:col-span-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">คำค้นหา</span>
            <div class="relative">
              <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11.25 18a6.75 6.75 0 100-13.5 6.75 6.75 0 000 13.5z" />
                </svg>
              </span>
              <input type="text" x-model="filters.keyword" @input.debounce.500ms="applyFilters" placeholder="ค้นหาชื่อ แท็ก หมายเหตุ หรือเจ้าของ"
                class="w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-10 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30" />
            </div>
          </label>
          <label class="flex flex-col gap-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">หมวดหมู่</span>
            <div>
              <input list="categoryOptions" x-model="filters.category" @input.debounce.500ms="applyFilters" placeholder="เช่น ส่วนตัว, ประกัน"
                class="w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-4 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30" />
              <datalist id="categoryOptions">
                <template x-for="category in categoryOptions" :key="category">
                  <option x-text="category"></option>
                </template>
              </datalist>
            </div>
          </label>
          <label class="flex flex-col gap-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">เรียงตาม</span>
            <select x-model="filters.sortField" @change="applyFilters"
              class="w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-4 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30">
              <option value="">ค่าเริ่มต้น</option>
              <option value="title">ชื่อ</option>
              <option value="category">หมวดหมู่</option>
              <option value="expiryDate">วันหมดอายุ</option>
            </select>
          </label>
          <label class="flex flex-col gap-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">ทิศทาง</span>
            <select x-model="filters.sortDirection" @change="applyFilters"
              class="w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-4 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30">
              <option value="asc">จากน้อยไปมาก</option>
              <option value="desc">จากมากไปน้อย</option>
            </select>
          </label>
          <div class="flex flex-col gap-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">ช่วงวันที่ออก</span>
            <div class="grid grid-cols-2 gap-2">
              <input type="date" x-model="filters.issueStart" @change="applyFilters" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30" />
              <input type="date" x-model="filters.issueEnd" @change="applyFilters" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30" />
            </div>
          </div>
          <div class="flex flex-col gap-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">ช่วงวันหมดอายุ</span>
            <div class="grid grid-cols-2 gap-2">
              <input type="date" x-model="filters.expiryStart" @change="applyFilters" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30" />
              <input type="date" x-model="filters.expiryEnd" @change="applyFilters" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/30" />
            </div>
          </div>
        </div>
      </div>
      <div class="p-6 space-y-6">
        <template x-if="isLoading">
          <div class="flex flex-col items-center justify-center gap-3 rounded-2xl border border-dashed border-slate-300/70 dark:border-slate-700/70 bg-white/60 dark:bg-slate-900/40 py-16 text-center text-sm text-slate-500 dark:text-slate-400">
            <div class="h-10 w-10 rounded-full border-2 border-primary border-t-transparent animate-spin"></div>
            <p>กำลังโหลดข้อมูลจาก Google Sheets...</p>
          </div>
        </template>

        <template x-if="!isLoading && documents.length && viewMode === 'table'">
          <div class="overflow-hidden rounded-2xl border border-slate-200/60 dark:border-slate-700/60 bg-white dark:bg-slate-900/40">
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-900/5 dark:bg-slate-800/60 text-slate-500 dark:text-slate-400 uppercase text-[11px] tracking-[0.2em]">
                  <tr>
                    <th class="px-5 py-3 text-left font-semibold">เอกสาร</th>
                    <th class="px-5 py-3 text-left font-semibold">หมวดหมู่ / เจ้าของ</th>
                    <th class="px-5 py-3 text-left font-semibold">วันที่สำคัญ</th>
                    <th class="px-5 py-3 text-left font-semibold">สถานะ</th>
                    <th class="px-5 py-3 text-left font-semibold">ไฟล์</th>
                    <th class="px-5 py-3 text-left font-semibold">อัปเดตล่าสุด</th>
                    <th class="px-5 py-3 text-right font-semibold">การจัดการ</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-200/60 dark:divide-slate-800/80 text-slate-700 dark:text-slate-200">
                  <template x-for="doc in documents" :key="doc.id">
                    <tr class="hover:bg-primary/5 dark:hover:bg-primary/10 transition">
                      <td class="px-5 py-4 align-top">
                        <div class="font-semibold text-slate-900 dark:text-white" x-text="doc.title"></div>
                        <div class="mt-1 text-xs text-slate-500 dark:text-slate-400" x-show="doc.notes" x-text="doc.notes"></div>
                        <div class="mt-2 flex flex-wrap gap-1.5">
                          <template x-for="tag in doc.tags" :key="tag">
                            <span class="inline-flex items-center rounded-full bg-slate-200/80 dark:bg-slate-800 px-2 py-0.5 text-[11px] text-slate-600 dark:text-slate-300" x-text="tag"></span>
                          </template>
                        </div>
                      </td>
                      <td class="px-5 py-4 align-top">
                        <div class="text-sm font-medium" x-text="doc.category || '-' "></div>
                        <div class="text-xs text-slate-500 dark:text-slate-400" x-text="doc.owner || '-' "></div>
                      </td>
                      <td class="px-5 py-4 align-top text-xs text-slate-500 dark:text-slate-400">
                        <div>ออก: <span class="font-medium text-slate-700 dark:text-slate-200" x-text="formatDate(doc.issueDate) || '-' "></span></div>
                        <div class="mt-1 flex items-center gap-2">หมดอายุ:
                          <span class="font-medium text-slate-700 dark:text-slate-200" x-text="formatDate(doc.expiryDate) || '-' "></span>
                          <span x-show="doc.expiryBadge" :class="doc.expiryBadge?.class" class="text-[10px] px-2 py-0.5 rounded-full font-semibold" x-text="doc.expiryBadge?.label"></span>
                        </div>
                      </td>
                      <td class="px-5 py-4 align-top">
                        <span :class="statusBadge(doc.status)" class="inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-semibold uppercase tracking-wide" x-text="doc.status"></span>
                      </td>
                      <td class="px-5 py-4 align-top text-xs text-slate-500 dark:text-slate-400">
                        <div class="flex items-center gap-2">
                          <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-primary/10 text-primary font-semibold" x-text="doc.driveFiles?.length || 0"></span>
                          <button @click="viewDetail(doc)" class="rounded-full border border-primary/30 bg-primary/10 px-3 py-1 text-[11px] text-primary hover:bg-primary/20">ดูไฟล์</button>
                        </div>
                      </td>
                      <td class="px-5 py-4 align-top text-xs text-slate-500 dark:text-slate-400">
                        <div x-text="doc.updatedAt ? doc.updatedAt.replace('T', ' ').slice(0, 16) : '-' "></div>
                      </td>
                      <td class="px-5 py-4 align-top">
                        <div class="flex flex-wrap justify-end gap-2">
                          <button @click="viewDetail(doc)" class="rounded-full border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/80 px-3 py-1.5 text-xs font-semibold text-slate-600 dark:text-slate-200 hover:border-primary hover:text-primary">รายละเอียด</button>
                          <button @click="openEditForm(doc)" :disabled="isLocked" class="rounded-full bg-primary/20 px-3 py-1.5 text-xs font-semibold text-primary hover:bg-primary/30 disabled:opacity-40 disabled:cursor-not-allowed">แก้ไข</button>
                          <button @click="archiveDocument(doc)" :disabled="isLocked" class="rounded-full bg-danger/10 px-3 py-1.5 text-xs font-semibold text-danger hover:bg-danger/20 disabled:opacity-40 disabled:cursor-not-allowed">Archive</button>
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>

        <template x-if="!isLoading && documents.length && viewMode === 'card'">
          <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
            <template x-for="doc in documents" :key="doc.id">
              <div class="relative overflow-hidden rounded-3xl border border-white/60 dark:border-slate-800/70 bg-white/80 dark:bg-slate-900/50 backdrop-blur p-6 shadow-lg transition hover:-translate-y-1 hover:shadow-xl">
                <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-primary via-success to-emerald-400 opacity-70"></div>
                <div class="flex items-start justify-between gap-4">
                  <div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white" x-text="doc.title"></h3>
                    <p class="mt-1 text-sm text-slate-500 dark:text-slate-400" x-text="doc.notes || 'ไม่มีหมายเหตุเพิ่มเติม'"></p>
                  </div>
                  <span :class="statusBadge(doc.status)" class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide" x-text="doc.status"></span>
                </div>
                <div class="mt-4 grid gap-2 text-xs text-slate-500 dark:text-slate-400">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-slate-200/70 dark:bg-slate-800/80 text-slate-600 dark:text-slate-200 font-semibold" x-text="doc.category ? doc.category.charAt(0).toUpperCase() : '-' "></span>
                    <div>
                      <div class="font-semibold text-slate-700 dark:text-slate-200" x-text="doc.category || 'ไม่ระบุหมวดหมู่'"></div>
                      <div x-text="doc.owner || '-' "></div>
                    </div>
                  </div>
                  <div class="flex flex-wrap items-center gap-2">
                    <span class="inline-flex items-center gap-1 rounded-full bg-slate-200/70 dark:bg-slate-800/80 px-3 py-1">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3.75h7.5M8.25 6h7.5m-9 3h10.5m-12 3h13.5m-13.5 3h13.5m-12 3h10.5" />
                      </svg>
                      <span x-text="formatDate(doc.issueDate) || '-' "></span>
                    </span>
                    <span class="inline-flex items-center gap-1 rounded-full bg-slate-200/70 dark:bg-slate-800/80 px-3 py-1">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l3.5 2.1" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 1115 0 7.5 7.5 0 01-15 0z" />
                      </svg>
                      <span x-text="formatDate(doc.expiryDate) || '-' "></span>
                    </span>
                    <span x-show="doc.expiryBadge" :class="doc.expiryBadge?.class" class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <span x-text="doc.expiryBadge?.label"></span>
                    </span>
                  </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                  <template x-for="tag in doc.tags" :key="tag">
                    <span class="rounded-full bg-primary/10 px-3 py-1 text-xs font-medium text-primary" x-text="tag"></span>
                  </template>
                  <template x-if="!(doc.tags && doc.tags.length)">
                    <span class="rounded-full bg-slate-200/60 px-3 py-1 text-xs text-slate-500 dark:text-slate-400">ไม่มีแท็ก</span>
                  </template>
                </div>
                <div class="mt-4 space-y-2 text-xs text-slate-500 dark:text-slate-400">
                  <div class="font-semibold text-slate-600 dark:text-slate-300">ไฟล์แนบ</div>
                  <div class="flex flex-wrap gap-2">
                    <template x-for="file in doc.driveFiles" :key="file.id">
                      <a :href="file.url" target="_blank" class="group inline-flex items-center gap-2 rounded-full border border-slate-200 dark:border-slate-700 px-3 py-1 text-xs text-slate-600 dark:text-slate-300 hover:border-primary hover:text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 12.75l3 3 6-6" />
                        </svg>
                        <span x-text="file.name || file.id"></span>
                      </a>
                    </template>
                    <template x-if="!(doc.driveFiles && doc.driveFiles.length)">
                      <span class="inline-flex items-center gap-1 rounded-full bg-slate-200/60 px-3 py-1 text-xs text-slate-500 dark:text-slate-400">ไม่มีไฟล์</span>
                    </template>
                  </div>
                </div>
                <div class="mt-6 flex flex-wrap gap-2 border-t border-slate-200/60 dark:border-slate-800/60 pt-4">
                  <button @click="viewDetail(doc)" class="flex-1 rounded-full bg-white/80 dark:bg-slate-800/80 px-4 py-2 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-primary/10 hover:text-primary">รายละเอียด</button>
                  <button @click="openEditForm(doc)" :disabled="isLocked" class="flex-1 rounded-full bg-primary/20 px-4 py-2 text-sm font-semibold text-primary hover:bg-primary/30 disabled:opacity-40 disabled:cursor-not-allowed">แก้ไข</button>
                  <button @click="archiveDocument(doc)" :disabled="isLocked" class="flex-1 rounded-full bg-danger/10 px-4 py-2 text-sm font-semibold text-danger hover:bg-danger/20 disabled:opacity-40 disabled:cursor-not-allowed">Archive</button>
                </div>
              </div>
            </template>
          </div>
        </template>

        <template x-if="!isLoading && !documents.length">
          <div class="flex flex-col items-center justify-center gap-4 rounded-2xl border border-dashed border-slate-300/70 dark:border-slate-700/70 bg-white/60 dark:bg-slate-900/40 py-16 text-center">
            <div class="flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 017.5 7.5V21l-3-2-3 2v-7.5A7.5 7.5 0 0010.5 6zM6 9h.008v.008H6V9z" />
              </svg>
            </div>
            <div class="space-y-2 max-w-xl">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white" x-text="settings.readyForData ? 'ไม่พบข้อมูลตามเงื่อนไขที่เลือก' : 'ยังไม่เชื่อมต่อฐานข้อมูล' "></h3>
              <p class="text-sm text-slate-500 dark:text-slate-400">
                <span x-show="settings.readyForData">ลองรีเซ็ตตัวกรองหรือเริ่มเพิ่มเอกสารใหม่เพื่อเริ่มต้นบันทึกข้อมูล</span>
                <span x-show="!settings.readyForData">ไปที่หน้า Settings เพื่อสร้างชีตและโฟลเดอร์ให้พร้อมก่อน จากนั้นรีเฟรชเพื่อโหลดข้อมูล</span>
              </p>
            </div>
            <div class="flex flex-wrap justify-center gap-2">
              <button x-show="settings.readyForData" @click="openCreateForm" :disabled="isLocked" class="rounded-full bg-success/20 px-4 py-2 text-sm font-semibold text-success hover:bg-success/30 disabled:opacity-40 disabled:cursor-not-allowed">เพิ่มเอกสารแรก</button>
              <button x-show="!settings.readyForData" @click="openSettings" class="rounded-full border border-primary/40 bg-primary/10 px-4 py-2 text-sm font-semibold text-primary hover:bg-primary/20">เปิด Settings</button>
              <button @click="refresh" class="rounded-full border border-slate-200 dark:border-slate-700 px-4 py-2 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-800/60">รีเซ็ตตัวกรอง</button>
            </div>
          </div>
        </template>

        <template x-if="!isLoading && documents.length">
          <div class="flex flex-col gap-3 text-xs text-slate-500 dark:text-slate-400 sm:flex-row sm:items-center sm:justify-between">
            <div>หน้า <span class="font-semibold text-primary" x-text="page"></span> / <span x-text="totalPages"></span> • ทั้งหมด <span class="font-semibold" x-text="total"></span> รายการ</div>
            <div class="inline-flex items-center gap-2">
              <button @click="changePage(page-1)" :disabled="page<=1" class="rounded-full border border-slate-200 dark:border-slate-700 px-3 py-1.5 hover:bg-slate-200/60 dark:hover:bg-slate-800/60 disabled:opacity-40">ก่อนหน้า</button>
              <button @click="changePage(page+1)" :disabled="page>=totalPages" class="rounded-full border border-slate-200 dark:border-slate-700 px-3 py-1.5 hover:bg-slate-200/60 dark:hover:bg-slate-800/60 disabled:opacity-40">ถัดไป</button>
            </div>
          </div>
        </template>
      </div>
    </section>

    <!-- Form modal -->
    <div x-show="showForm" x-transition class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-30">
      <div class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto scrollbar-thin">
        <div class="flex justify-between items-center border-b border-slate-200 dark:border-slate-700 px-4 py-3">
          <h2 class="text-xl font-semibold" x-text="form.id ? 'แก้ไขเอกสาร' : 'เพิ่มเอกสาร'"></h2>
          <button @click="closeForm" class="text-slate-400 hover:text-white">✕</button>
        </div>
        <form @submit.prevent="submitForm" class="p-4 space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <label class="flex flex-col gap-1 text-sm">
              <span>ชื่อเอกสาร *</span>
              <input x-model="form.title" required class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" placeholder="เช่น บัตรประชาชน" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span>หมวดหมู่</span>
              <input x-model="form.category" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" placeholder="เช่น ส่วนตัว" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span>แท็ก (คั่นด้วย ,)</span>
              <input x-model="form.tags" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" placeholder="passport,important" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span>เจ้าของ/อีเมล</span>
              <input x-model="form.owner" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" placeholder="name@email.com" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span>วันที่ออก</span>
              <input type="date" x-model="form.issueDate" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span>วันหมดอายุ</span>
              <input type="date" x-model="form.expiryDate" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span>แจ้งเตือนล่วงหน้า (วัน)</span>
              <input type="number" min="0" x-model.number="form.remindDays" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" />
            </label>
            <label class="flex flex-col gap-1 text-sm">
              <span>สถานะ</span>
              <select x-model="form.status" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100">
                <option value="active">Active</option>
                <option value="archived">Archived</option>
                <option value="expired">Expired</option>
              </select>
            </label>
          </div>
          <label class="flex flex-col gap-1 text-sm">
            <span>สถานที่เก็บจริง</span>
            <input x-model="form.location" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" placeholder="ชั้นเอกสาร" />
          </label>
          <label class="flex flex-col gap-1 text-sm">
            <span>แหล่งที่มา</span>
            <input x-model="form.source" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" placeholder="สแกน, ถ่ายรูป" />
          </label>
          <label class="flex flex-col gap-1 text-sm">
            <span>หมายเหตุ</span>
            <textarea x-model="form.notes" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" rows="3"></textarea>
          </label>

          <div class="border border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-4 text-center bg-white/60 dark:bg-transparent"
            @dragover.prevent
            @drop.prevent="handleDroppedFiles($event)">
            <p class="text-sm text-slate-600 dark:text-slate-300">แนบไฟล์ (ลากวางได้ รองรับหลายไฟล์)</p>
            <input type="file" multiple class="hidden" x-ref="fileInput" @change="handleFileSelection($event)" />
            <button type="button" @click="$refs.fileInput.click()" class="mt-2 px-3 py-2 bg-slate-200 dark:bg-slate-800 text-slate-800 dark:text-slate-100 rounded">เลือกไฟล์</button>
            <div class="mt-3 space-y-2 text-left" x-show="form.driveFiles.length">
              <template x-for="file in form.driveFiles" :key="file.id + file.name">
                <div class="flex items-center justify-between text-sm bg-slate-200 dark:bg-slate-800/60 text-slate-800 dark:text-slate-100 px-3 py-2 rounded">
                  <div>
                    <div x-text="file.name"></div>
                    <a :href="file.url" target="_blank" class="text-primary text-xs">เปิดใน Drive</a>
                  </div>
                  <button type="button" @click="removeAttachment(file)" class="text-danger text-xs">ลบ</button>
                </div>
              </template>
            </div>
          </div>

          <div class="flex justify-end gap-3">
            <button type="button" @click="closeForm" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">ยกเลิก</button>
            <button type="submit" class="px-4 py-2 bg-success/20 text-success rounded">บันทึก</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Detail modal -->
    <div x-show="showDetail" x-transition class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-20">
      <div class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto scrollbar-thin">
        <div class="flex justify-between items-center border-b border-slate-200 dark:border-slate-700 px-4 py-3">
          <h2 class="text-xl font-semibold">รายละเอียดเอกสาร</h2>
          <button @click="closeDetail" class="text-slate-400 hover:text-white">✕</button>
        </div>
        <div class="p-4 space-y-4 text-sm">
          <div class="grid md:grid-cols-2 gap-4">
            <div><span class="text-slate-400">ชื่อ: </span><span x-text="selected?.title"></span></div>
            <div><span class="text-slate-400">หมวดหมู่: </span><span x-text="selected?.category"></span></div>
            <div><span class="text-slate-400">เจ้าของ: </span><span x-text="selected?.owner"></span></div>
            <div><span class="text-slate-400">สถานะ: </span><span x-text="selected?.status"></span></div>
            <div><span class="text-slate-400">วันที่ออก: </span><span x-text="formatDate(selected?.issueDate)"></span></div>
            <div><span class="text-slate-400">วันหมดอายุ: </span><span x-text="formatDate(selected?.expiryDate)"></span></div>
            <div><span class="text-slate-400">แจ้งเตือนล่วงหน้า: </span><span x-text="selected?.remindDays + ' วัน'"></span></div>
            <div><span class="text-slate-400">สถานที่เก็บ: </span><span x-text="selected?.location"></span></div>
            <div class="md:col-span-2"><span class="text-slate-400">หมายเหตุ: </span><span x-text="selected?.notes"></span></div>
          </div>
          <div>
            <h3 class="font-semibold text-sm mb-2">ไฟล์แนบ</h3>
            <div class="space-y-2">
              <template x-for="file in selected?.driveFiles || []" :key="file.id">
                <div class="flex justify-between items-center bg-slate-200 dark:bg-slate-800/60 text-slate-800 dark:text-slate-100 px-3 py-2 rounded">
                  <div>
                    <div x-text="file.name"></div>
                    <div class="text-xs text-slate-400" x-text="file.id"></div>
                  </div>
                  <div class="flex gap-2">
                    <a :href="file.url" target="_blank" class="px-3 py-1 bg-primary/30 text-primary rounded text-xs">เปิดไฟล์</a>
                    <button @click="copyToClipboard(file.url)" class="px-3 py-1 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded text-xs">คัดลอกลิงก์</button>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-sm mb-2">ประวัติเวอร์ชัน</h3>
            <ol class="space-y-2">
              <template x-for="version in selected?.versionHistory || []" :key="version.version + version.fileId">
                <li class="bg-slate-200 dark:bg-slate-800/60 text-slate-800 dark:text-slate-100 px-3 py-2 rounded">
                  <div class="flex justify-between items-center">
                    <div>
                      <div class="font-semibold" x-text="version.version + ' - ' + (version.fileName || '')"></div>
                      <div class="text-xs text-slate-400" x-text="version.uploadedAt"></div>
                    </div>
                    <div class="flex gap-2 text-xs">
                    <a :href="version.fileUrl" target="_blank" class="px-3 py-1 bg-primary/30 text-primary rounded">เปิด</a>
                      <button @click="copyToClipboard(version.fileUrl)" class="px-3 py-1 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">คัดลอก</button>
                    </div>
                  </div>
                </li>
              </template>
            </ol>
          </div>
          <div class="flex justify-end gap-2">
            <button @click="printDocument(selected)" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">พิมพ์</button>
            <button @click="closeDetail" class="px-4 py-2 bg-primary/30 text-primary rounded">ปิด</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings modal -->
    <div x-show="showSettings" x-transition class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-40">
      <div class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto scrollbar-thin">
        <div class="flex justify-between items-center border-b border-slate-200 dark:border-slate-700 px-4 py-3">
          <h2 class="text-xl font-semibold">ตั้งค่า &amp; ผู้ดูแล</h2>
          <button @click="closeSettings" class="text-slate-400 hover:text-white">✕</button>
        </div>
        <div class="p-4 space-y-4 text-sm">
          <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4">
            <h3 class="font-semibold text-slate-700 dark:text-slate-200">โหมดผู้ดูแล</h3>
            <p class="text-slate-500 dark:text-slate-400 text-sm">สถานะ: <span :class="isLocked ? 'text-danger' : 'text-success'" x-text="isLocked ? 'ล็อก' : 'ปลดล็อก'"></span></p>
            <div class="flex gap-2 mt-3">
              <input type="password" x-model="adminPassword" placeholder="{{ADMIN_PASS}}" class="flex-1 bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded px-3 py-2 text-slate-800 dark:text-slate-100" />
              <button @click="unlockAdmin" class="px-4 py-2 bg-success/20 text-success rounded">ปลดล็อก</button>
              <button @click="lockAdmin" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">ล็อก</button>
            </div>
          </div>

          <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4 space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">สร้างฐานข้อมูลอัตโนมัติ</h3>
              <span class="text-xs px-2 py-1 rounded-full"
                :class="settings.readyForData ? (settings.setupComplete ? 'bg-success/20 text-success' : 'bg-warning/20 text-warning') : 'bg-danger/20 text-danger'"
                x-text="settings.readyForData ? (settings.setupComplete ? 'พร้อมใช้งานเต็มรูปแบบ' : 'เชื่อมต่อชีตแล้ว') : 'ยังไม่ตั้งค่า'"></span>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400">กดปุ่มเพื่อให้ระบบสร้าง Google Sheet พร้อมหัวคอลัมน์และโฟลเดอร์ Google Drive รวมถึงเติมข้อมูลตัวอย่างให้อัตโนมัติ</p>
            <div class="flex gap-2 flex-wrap">
              <button @click="provisionWorkspace(false)" :disabled="isProvisioning" class="px-4 py-2 bg-success/20 text-success rounded disabled:opacity-40 disabled:cursor-not-allowed">สร้างชีต &amp; โฟลเดอร์</button>
              <button @click="provisionWorkspace(true)" :disabled="isProvisioning" class="px-4 py-2 bg-warning/20 text-warning rounded disabled:opacity-40 disabled:cursor-not-allowed">บังคับสร้างใหม่</button>
            </div>
            <template x-if="provisionResult">
              <div class="text-xs space-y-1 bg-white/40 dark:bg-slate-900/40 border border-slate-200 dark:border-slate-700 rounded p-3">
                <p>Sheet: <a :href="provisionResult.sheet.url" target="_blank" class="text-primary underline" x-text="provisionResult.sheet.id"></a> <span x-text="provisionResult.sheet.created ? '(สร้างใหม่)' : '(ใช้ของเดิม)'"></span></p>
                <p>แท็บ: <span class="text-primary" x-text="provisionResult.sheet.name"></span></p>
                <p>Drive Folder: <a :href="provisionResult.folder.url" target="_blank" class="text-primary underline" x-text="provisionResult.folder.id"></a> <span x-text="provisionResult.folder.created ? '(สร้างใหม่)' : '(ใช้ของเดิม)'"></span></p>
                <p>Seed rows: <span class="text-primary" x-text="provisionResult.seededRows"></span></p>
              </div>
            </template>
          </div>

          <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4 space-y-2">
            <h3 class="font-semibold">ข้อมูลการเชื่อมต่อ</h3>
            <p>Sheet ID: <span class="text-primary" x-text="settings.sheetId"></span></p>
            <p>Sheet Name: <span class="text-primary" x-text="settings.sheetName"></span></p>
            <p>Drive Folder ID: <span class="text-primary" x-text="settings.driveFolderId"></span></p>
            <p>สถานะชีต: <span :class="settings.isSheetReady ? 'text-success' : 'text-danger'" x-text="settings.isSheetReady ? 'พร้อมใช้งาน' : 'ยังไม่สร้าง'"></span></p>
            <p>สถานะโฟลเดอร์: <span :class="settings.isFolderReady ? 'text-success' : 'text-danger'" x-text="settings.isFolderReady ? 'พร้อมใช้งาน' : 'ยังไม่สร้าง'"></span></p>
          </div>

          <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4 space-y-3">
            <h3 class="font-semibold">การสำรองและทริกเกอร์</h3>
            <div class="flex gap-2 flex-wrap">
              <button @click="createTriggers" class="px-4 py-2 bg-primary/30 text-primary rounded">สร้าง Trigger อัตโนมัติ</button>
              <button @click="deleteTriggers" class="px-4 py-2 bg-danger/20 text-danger rounded">ลบ Trigger</button>
              <button @click="manualBackup" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">สำรองข้อมูลทันที</button>
              <button @click="downloadExport('csv')" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">Export CSV</button>
              <button @click="downloadExport('json')" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">Export JSON</button>
              <button @click="ping" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-100 rounded">Health Check</button>
            </div>
          </div>

          <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-4 space-y-2">
            <h3 class="font-semibold">ตัวอย่างอีเมลแจ้งเตือน</h3>
            <pre class="bg-slate-900 rounded p-3 text-xs whitespace-pre-wrap">To: เจ้าของ (owner@email.com)
Subject: [Document Expiry Notice] ชื่อเอกสาร

เอกสาร: ชื่อเอกสาร
เจ้าของ: owner@email.com
วันหมดอายุ: 2024-12-31
สถานะ: active
ลิงก์เว็บแอป: https://script.google.com/macros/s/WEB_APP_ID/exec
ไฟล์:
 - ไฟล์หลัก: https://drive.google.com/open?id=FILE_ID</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notifications -->
  <div class="fixed bottom-4 right-4 space-y-2 z-50">
    <template x-for="toast in toasts" :key="toast.id">
      <div class="px-4 py-3 rounded-lg shadow bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 text-sm text-slate-800 dark:text-slate-100" x-text="toast.message"></div>
    </template>
  </div>

  <script>
    function appState() {
      return {
        darkMode: true,
        documents: [],
        summary: { total: 0, aboutToExpire: 0, expired: 0 },
        categoryOptions: [],
        isLoading: false,
        viewMode: 'table',
        page: 1,
        totalPages: 1,
        total: 0,
        filters: {
          keyword: '',
          status: '',
          category: '',
          issueStart: '',
          issueEnd: '',
          expiryStart: '',
          expiryEnd: '',
          sortField: '',
          sortDirection: 'asc',
        },
        settings: {
          sheetId: '',
          sheetName: '',
          driveFolderId: '',
          setupComplete: false,
          isSheetReady: false,
          isFolderReady: false,
          readyForData: false,
          appName: '{{APP_NAME}}',
        },
        adminPassword: '',
        isLocked: true,
        showForm: false,
        showDetail: false,
        showSettings: false,
        selected: null,
        form: {
          id: null,
          title: '',
          category: '',
          tags: '',
          owner: '',
          issueDate: '',
          expiryDate: '',
          remindDays: 0,
          status: 'active',
          location: '',
          source: '',
          notes: '',
          driveFiles: [],
        },
        isProvisioning: false,
        provisionResult: null,
        toasts: [],
        init() {
          console.log('init app');
          this.fetchSettings()
            .then(() => {
              if (this.settings.readyForData) {
                this.loadDocuments();
              }
            })
            .catch(() => {});
        },
        toggleDarkMode() {
          this.darkMode = !this.darkMode;
        },
        formatDate(value) {
          if (!value) return '';
          try {
            return new Date(value).toISOString().slice(0, 10);
          } catch (e) {
            return value;
          }
        },
        statusBadge(status) {
          switch ((status || '').toLowerCase()) {
            case 'active':
              return 'bg-success/10 text-success border border-success/40';
            case 'archived':
              return 'bg-slate-200/70 dark:bg-slate-700/70 text-slate-700 dark:text-slate-200 border border-slate-300/60 dark:border-slate-600/60';
            case 'expired':
              return 'bg-danger/10 text-danger border border-danger/40';
            default:
              return 'bg-slate-200/70 dark:bg-slate-700/70 text-slate-700 dark:text-slate-200 border border-slate-300/60 dark:border-slate-600/60';
          }
        },
        computeExpiryBadge(doc) {
          if (!doc.expiryDate) return null;
          const diff = Math.ceil((new Date(doc.expiryDate) - new Date()) / (1000 * 3600 * 24));
          if (isNaN(diff)) return null;
          if (diff < 0) return { label: 'หมดอายุ', class: 'bg-danger/10 text-danger border border-danger/40', days: diff };
          if (diff === 0) return { label: 'หมดอายุวันนี้', class: 'bg-warning/10 text-warning border border-warning/40', days: diff };
          if (diff <= doc.remindDays) return { label: 'เหลือ ' + diff + ' วัน', class: 'bg-warning/10 text-warning border border-warning/40', days: diff };
          return null;
        },
        refresh() {
          this.fetchSettings()
            .then(() => {
              if (this.settings.readyForData) {
                this.loadDocuments();
              }
            })
            .catch(() => {});
        },
        loadDocuments(page = this.page) {
          if (!this.settings.readyForData) {
            console.warn('workspace not provisioned yet');
            this.summary = { total: 0, aboutToExpire: 0, expired: 0 };
            this.documents = [];
            this.isLoading = false;
            return Promise.resolve();
          }
          const payload = {
            page: page,
            pageSize: 20,
            keyword: this.filters.keyword,
            category: this.filters.category,
            status: this.filters.status,
            issueRange: { start: this.filters.issueStart, end: this.filters.issueEnd },
            expiryRange: { start: this.filters.expiryStart, end: this.filters.expiryEnd },
            sort: { field: this.filters.sortField, direction: this.filters.sortDirection },
          };
          console.log('loadDocuments', payload);
          this.isLoading = true;
          return this.callApi('list', payload)
            .then((res) => {
              this.documents = (res.items || []).map((doc) => {
                doc.expiryBadge = this.computeExpiryBadge(doc);
                return doc;
              });
              this.summary = res.summary || { total: 0, aboutToExpire: 0, expired: 0 };
              this.categoryOptions = res.categories || [];
              this.page = res.page;
              this.totalPages = res.totalPages;
              this.total = res.total;
            })
            .catch((err) => this.notify(err.message || 'โหลดข้อมูลไม่สำเร็จ'))
            .finally(() => { this.isLoading = false; });
        },
        changePage(newPage) {
          if (newPage < 1 || newPage > this.totalPages) return;
          this.loadDocuments(newPage);
        },
        applyFilters() {
          this.loadDocuments(1);
        },
        openCreateForm() {
          if (this.isLocked) {
            this.notify('กรุณาปลดล็อกก่อนแก้ไข');
            return;
          }
          this.resetForm();
          this.showForm = true;
        },
        openEditForm(doc) {
          if (this.isLocked) {
            this.notify('โหมดผู้ดูแลถูกล็อก');
            return;
          }
          this.resetForm();
          this.form.id = doc.id;
          this.form.title = doc.title;
          this.form.category = doc.category;
          this.form.tags = doc.tags.join(', ');
          this.form.owner = doc.owner;
          this.form.issueDate = doc.issueDate ? doc.issueDate.slice(0, 10) : '';
          this.form.expiryDate = doc.expiryDate ? doc.expiryDate.slice(0, 10) : '';
          this.form.remindDays = doc.remindDays;
          this.form.status = doc.status;
          this.form.location = doc.location;
          this.form.source = doc.source;
          this.form.notes = doc.notes;
          this.form.driveFiles = doc.driveFiles ? JSON.parse(JSON.stringify(doc.driveFiles)) : [];
          this.showForm = true;
        },
        openSettings() {
          this.showSettings = true;
        },
        closeSettings() {
          this.showSettings = false;
        },
        resetForm() {
          this.form = {
            id: null,
            title: '',
            category: '',
            tags: '',
            owner: '',
            issueDate: '',
            expiryDate: '',
            remindDays: 0,
            status: 'active',
            location: '',
            source: '',
            notes: '',
            driveFiles: [],
          };
        },
        closeForm() {
          this.showForm = false;
        },
        viewDetail(doc) {
          this.selected = doc;
          this.showDetail = true;
        },
        closeDetail() {
          this.showDetail = false;
          this.selected = null;
        },
        submitForm() {
          const payload = {
            title: this.form.title,
            category: this.form.category,
            tags: this.form.tags ? this.form.tags.split(',').map(t => t.trim()).filter(Boolean) : [],
            owner: this.form.owner,
            issueDate: this.form.issueDate,
            expiryDate: this.form.expiryDate,
            remindDays: this.form.remindDays || 0,
            status: this.form.status,
            location: this.form.location,
            source: this.form.source,
            notes: this.form.notes,
            driveFiles: this.form.driveFiles,
          };
          const action = this.form.id ? 'update' : 'create';
          if (this.form.id) payload.id = this.form.id;
          console.log('submitForm', action, payload);
          this.callApi(action, payload)
            .then(() => {
              this.notify('บันทึกข้อมูลสำเร็จ');
              this.showForm = false;
              this.loadDocuments();
            })
            .catch((err) => this.notify(err.message || 'เกิดข้อผิดพลาด'));
        },
        archiveDocument(doc) {
          if (!confirm('ต้องการ archive รายการนี้?')) return;
          this.callApi('archive', { id: doc.id })
            .then(() => {
              this.notify('Archive สำเร็จ');
              this.loadDocuments();
            })
            .catch((err) => this.notify(err.message || 'Archive ไม่สำเร็จ'));
        },
        handleDroppedFiles(event) {
          const files = event.dataTransfer.files;
          this.uploadSelectedFiles(files);
        },
        handleFileSelection(event) {
          const files = event.target.files;
          this.uploadSelectedFiles(files);
          event.target.value = '';
        },
        uploadSelectedFiles(fileList) {
          if (!fileList || !fileList.length) return;
          const readers = [];
          for (let i = 0; i < fileList.length; i++) {
            const file = fileList[i];
            readers.push(this.fileToBase64(file));
          }
          Promise.all(readers).then((encoded) => {
            const filesPayload = encoded.map(f => ({ name: f.name, base64: f.base64.split(',')[1], type: f.type }));
            this.callApi('upload', { files: filesPayload })
              .then((res) => {
                const uploaded = res.files || [];
                this.form.driveFiles = this.form.driveFiles.concat(uploaded);
                this.notify('อัปโหลดไฟล์ ' + uploaded.length + ' ไฟล์สำเร็จ');
              })
              .catch((err) => this.notify(err.message || 'อัปโหลดไม่สำเร็จ'));
          });
        },
        fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve({ name: file.name, base64: reader.result, type: file.type });
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        },
        removeAttachment(file) {
          this.form.driveFiles = this.form.driveFiles.filter(f => f.id !== file.id);
        },
        fetchSettings() {
          return this.callApi('settings', {})
            .then((res) => {
              this.settings = Object.assign({
                sheetId: '',
                sheetName: '',
                driveFolderId: '',
                setupComplete: false,
                isSheetReady: false,
                isFolderReady: false,
                readyForData: false,
                appName: '{{APP_NAME}}',
              }, res || {});
            })
            .catch((err) => {
              console.error('fetchSettings error', err);
            });
        },
        unlockAdmin() {
          if (!this.adminPassword) {
            this.notify('กรุณากรอกรหัสผ่านผู้ดูแล');
            return;
          }
          this.callApi('verifyAdmin', { password: this.adminPassword })
            .then(() => {
              this.isLocked = false;
              this.notify('ปลดล็อกโหมดผู้ดูแลแล้ว');
            })
            .catch((err) => {
              this.notify(err.message || 'รหัสผ่านไม่ถูกต้อง');
            });
        },
        lockAdmin() {
          this.isLocked = true;
          this.adminPassword = '';
          this.notify('ล็อกโหมดผู้ดูแล');
        },
        provisionWorkspace(forceNew) {
          const appName = this.settings.appName && this.settings.appName !== '{{APP_NAME}}'
            ? this.settings.appName
            : '{{APP_NAME}}';
          const sheetName = this.settings.sheetName && this.settings.sheetName !== '{{SHEET_NAME}}'
            ? this.settings.sheetName
            : '{{SHEET_NAME}}';
          const payload = {
            sheetTitle: appName + ' Metadata',
            sheetName: sheetName,
            folderName: appName + ' Files',
          };
          if (forceNew) {
            payload.forceNewSheet = true;
            payload.forceNewFolder = true;
          }
          if (this.adminPassword) {
            payload.adminPass = this.adminPassword;
          } else {
            const promptPass = prompt('กำหนดรหัสผ่านผู้ดูแล (เว้นว่างหากตั้งภายหลัง)', '');
            if (promptPass) {
              payload.adminPass = promptPass;
              this.adminPassword = promptPass;
            }
          }
          this.isProvisioning = true;
          this.callApi('provisionWorkspace', payload)
            .then((res) => {
              this.provisionResult = res;
              this.notify('เตรียมฐานข้อมูลสำเร็จ');
              this.fetchSettings()
                .then(() => {
                  if (this.settings.readyForData) {
                    this.loadDocuments();
                  }
                });
            })
            .catch((err) => this.notify(err.message || 'สร้างฐานข้อมูลไม่สำเร็จ'))
            .finally(() => { this.isProvisioning = false; });
        },
        createTriggers() {
          this.callApi('createTriggers', {})
            .then(() => this.notify('สร้าง Trigger แล้ว'))
            .catch((err) => this.notify(err.message || 'สร้าง Trigger ไม่สำเร็จ'));
        },
        deleteTriggers() {
          this.callApi('deleteTriggers', {})
            .then(() => this.notify('ลบ Trigger แล้ว'))
            .catch((err) => this.notify(err.message || 'ลบ Trigger ไม่สำเร็จ'));
        },
        manualBackup() {
          this.callApi('backupSheet', {})
            .then((res) => this.notify('สำรองสำเร็จ: ' + res.backupUrl))
            .catch((err) => this.notify(err.message || 'สำรองไม่สำเร็จ'));
        },
        downloadExport(type) {
          this.callApi(type === 'csv' ? 'exportCSV' : 'exportJSON', {})
            .then((res) => {
              const blob = new Blob([res.content], { type: res.mimeType });
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = res.filename;
              link.click();
              URL.revokeObjectURL(link.href);
            })
            .catch((err) => this.notify(err.message || 'Export ล้มเหลว'));
        },
        ping() {
          this.callApi('ping', {})
            .then((res) => this.notify('ระบบพร้อมใช้งาน: ' + res.timestamp))
            .catch((err) => this.notify(err.message || 'Ping ล้มเหลว'));
        },
        printDocument(doc) {
          if (!doc) return;
          const printable = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Print ${doc.title}</title>
            <style>body{font-family:sans-serif;padding:20px;}table{width:100%;border-collapse:collapse;}td{border:1px solid #ccc;padding:8px;}
            h1{margin-bottom:10px;} .tags span{display:inline-block;margin-right:6px;padding:2px 6px;border-radius:4px;background:#e2e8f0;}</style>
            </head><body><h1>${doc.title}</h1><table>
            <tr><td>หมวดหมู่</td><td>${doc.category || ''}</td></tr>
            <tr><td>เจ้าของ</td><td>${doc.owner || ''}</td></tr>
            <tr><td>วันที่ออก</td><td>${this.formatDate(doc.issueDate)}</td></tr>
            <tr><td>วันหมดอายุ</td><td>${this.formatDate(doc.expiryDate)}</td></tr>
            <tr><td>แจ้งเตือนล่วงหน้า</td><td>${doc.remindDays || 0} วัน</td></tr>
            <tr><td>สถานะ</td><td>${doc.status}</td></tr>
            <tr><td>สถานที่เก็บ</td><td>${doc.location || ''}</td></tr>
            <tr><td>แหล่งที่มา</td><td>${doc.source || ''}</td></tr>
            <tr><td>หมายเหตุ</td><td>${doc.notes || ''}</td></tr>
            </table><h3>ไฟล์แนบ</h3><ul>${(doc.driveFiles || []).map(f => `<li><a href="${f.url}" target="_blank">${f.name || f.id}</a></li>`).join('')}</ul>
            </body></html>`;
          const printWindow = window.open('', '_blank');
          printWindow.document.write(printable);
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        },
        copyToClipboard(text) {
          navigator.clipboard.writeText(text).then(() => this.notify('คัดลอกแล้ว'));
        },
        notify(message) {
          const toast = { id: Date.now() + Math.random(), message };
          this.toasts.push(toast);
          setTimeout(() => {
            this.toasts = this.toasts.filter(t => t.id !== toast.id);
          }, 4000);
        },
        callApi(action, payload) {
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler((res) => {
                console.log('API success', action, res);
                resolve(res);
              })
              .withFailureHandler((err) => {
                console.error('API error', action, err);
                if (err && err.message) {
                  reject(err);
                } else {
                  reject(new Error('API error'));
                }
              })
              .handleApiRequest(action, payload || {});
          });
        },
      }
    }
  </script>
</body>
</html>
